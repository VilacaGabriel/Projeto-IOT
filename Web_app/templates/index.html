<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Monitor de Câmera e Controle</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="menu">
        <ul>
            <li class="lista-menu">
                <a href="#">
                    <img class="icones-menu" src="{{ url_for('static', filename='imgs/icon-home.png')}}" alt="Home"> 
                    Home
                </a>
            </li>
            <li class="lista-menu">
                <a href="{{ url_for('registro') }}">
                    <img class="icones-menu" src="{{ url_for('static', filename='imgs/icon-registros.png')}}" alt="Registros"> 
                    Registros
                </a>
            </li>
            <li class="lista-menu">
                <a href="#">
                    <img class="icones-menu" src="{{ url_for('static', filename='imgs/icon-configuracoes.png')}}" alt="Home"> 
                    Configurações </br> avançadas
                </a>
            </li>
        </ul>
    </nav>

    <div class="container-principal">
        <div class="box controles">
            <h1>Controles</h1>
            <ul>
                <li class="lista-controles">
                    <div class="motor-control">
                        <label for="velocidade_motores">Velocidade dos Motores</label>
                        <input type="range" id="velocidade_motores" min="0" max="1000" step="10" value="0" oninput="updateValue('motor')">
                        <span id="val1">000</span>
                        <button onclick="setSpeed()">Aplicar</button>
                    </div>
                </li>
                <li class="lista-controles">
                    <div class="motor-control">
                        <label for="intensidade_luzes">Intensidade Luzes</label>
                        <input type="range" id="intensidade_luzes" min="0" max="100" step="1" value="50" oninput="updateValue('led')">
                        <span id="val2">50%</span>
                        <button onclick="setLedIntensity()">Aplicar</button>
                    </div>
                </li>
            </ul>
        </div>

        <div class="box video-container">
            <h1>Monitoramento da Câmera</h1>
            <img class="img-video" src="{{ url_for('video') }}" width="640" height="480">
        </div>

        <div class="box monitoramento">
            <h1>Monitoramento de Componentes</h1>
            <li class="lista-controles">
                <div class="motor-control">
                    <div class="motores">
                        <div class="motor1">
                            <h3>Motor 1</h3>
                            <p>velocidade:</p>
                            <img class="icones-menu icones-monitoramento" src="{{ url_for('static', filename='imgs/icon-bobina.png')}}" alt="">
                            <p>Diametro da bobina:</p>
                        </div>
                        <div class="direcao">
                            <h3>Direção</h3>
                            <img class="icones-menu icones-monitoramento" src="{{ url_for('static', filename='imgs/icon-direcao.png')}}" alt="">
                        </div>
                        <div class="motor2">
                            <h3>Motor 2</h3>
                            <p>velocidade:</p>
                            <img class="icones-menu icones-monitoramento espelhado" src="{{ url_for('static', filename='imgs/icon-bobina.png')}}" alt="">
                            <p>Diametro da bobina:</p>
                        </div>
                    </div>
                </div>
            </li>
        </div>
    </div>

    <script>
        const espUrl = "{{ ESP_IP }}";  // pega do config.py

        // Atualiza o valor mostrado ao mover o slider
        function updateValue(tipo) {
            if(tipo === 'motor') {
                document.getElementById("val1").textContent = document.getElementById("velocidade_motores").value;
            } else if(tipo === 'led') {
                document.getElementById("val2").textContent = document.getElementById("intensidade_luzes").value + "%";
            }
        }

        // Envia a velocidade do motor para o ESP
        function setSpeed() {
            const valor = parseFloat(document.getElementById("velocidade_motores").value);
            fetch(`${espUrl}/motor/speed`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({velocidade: valor})
            })
            .then(res => res.json())
            .then(data => console.log("Velocidade aplicada:", data.velocidadeAplicada))
            .catch(err => console.error("Erro:", err));
        }

        // Envia intensidade do LED para o ESP
        function setLedIntensity() {
            const perc = parseInt(document.getElementById("intensidade_luzes").value);
            
            // Converte porcentagem (0–100) para PWM (0–255)
            const pwm = Math.round((perc / 100) * 255);

            fetch(`${espUrl}/led/set`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ brilho: pwm })
            })
            .then(res => res.text())
            .then(txt => console.log("LED aplicado:", txt))
            .catch(err => console.error("Erro:", err));
        }

        // Atualiza monitoramento de motores e bobinas a cada 500ms
        setInterval(() => {
            fetch(`${espUrl}/status`)
            .then(res => res.json())
            .then(data => {
                // Atualiza velocidade dos motores
                document.querySelector(".motor1 p").textContent = "velocidade: " + data.motor1.velocidade.toFixed(1);
                document.querySelector(".motor2 p").textContent = "velocidade: " + data.motor2.velocidade.toFixed(1);
                // Atualiza diâmetros
                document.querySelector(".motor1 p:nth-of-type(2)").textContent = "Diametro da bobina: " + data.sensores.dist1 + " mm";
                document.querySelector(".motor2 p:nth-of-type(2)").textContent = "Diametro da bobina: " + data.sensores.dist2 + " mm";
            })
            .catch(err => console.error("Erro fetch status:", err));
        }, 500);
    </script>
</body>
</html>
